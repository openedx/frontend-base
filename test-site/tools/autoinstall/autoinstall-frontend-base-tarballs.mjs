import chokidar from 'chokidar';
import fs from 'fs';
import { spawn } from 'child_process';
import { APP_ROOT, INSTALL_DEBOUNCE_MS, TGZ_FILENAME, TGZ_PATH } from './env.mjs';

const install = () => {
  return new Promise((resolve, reject) => {
    const installProcess = spawn(
      'npm',
      ['i', '--no-save', TGZ_PATH],
      { stdio: 'inherit', shell: false, cwd: APP_ROOT }
    );

    installProcess.once('error', reject);

    installProcess.once('exit', (code) => (
      code === 0
        ? resolve()
        : reject(new Error(`npm exited ${code}`))
    )
    );
  });
};

const tryInstall = async (trigger) => {
  console.log(`\n[install] ${TGZ_FILENAME} (${trigger})`);

  if (!fs.existsSync(TGZ_PATH)) {
    throw new Error(`${TGZ_FILENAME} not found at ${TGZ_PATH}`);
  }

  await install();
};

/**
 * Creates an autoinstaller that watches the frontend-base tgz
 * generated by npm pack and installs it.
 *
 * Usage:
 *   const installer = createInstaller({ onInstall: () => {...} });
 *   await installer.start();  // initial install + start watching
 *   await installer.stop();   // stop watching + clear timers
 */
export const createInstaller = ({
  onInstall,
}) => {
  let installing = false;
  let timer = null;
  let watcher;

  const runInstall = async (trigger) => {
    if (installing) {
      return;
    }

    installing = true;
    try {
      await tryInstall(trigger);
      await onInstall?.(trigger);
    } catch (e) {
      console.error('\n[error]', e.message || e);
    } finally {
      installing = false;
    }
  };

  const scheduleInstall = (trigger) => {
    if (timer) {
      clearTimeout(timer);
    }

    timer = setTimeout(() => runInstall(trigger), INSTALL_DEBOUNCE_MS);
  };

  const start = async () => {
    if (watcher) {
      console.warn('[install:watch] watcher already exists; start() called twice?');
      return;
    }

    console.log(`[install:watch] ${TGZ_PATH}`);

    watcher = chokidar
      .watch(TGZ_PATH, { ignoreInitial: true, awaitWriteFinish: true })
      .on('add', () => scheduleInstall('tgz:add'))
      .on('change', () => scheduleInstall('tgz:change'));

    // Explicit initial install (not relying on watcher)
    await tryInstall('initial');
  };

  const stop = async () => {
    if (timer) {
      clearTimeout(timer);
    }
    timer = null;

    await watcher?.close();
    watcher = null;
  };

  const installNow = async () => {
    if (timer) {
      clearTimeout(timer);
    }
    timer = null;

    await runInstall('manual');
  };

  return { start, stop, installNow };
};
